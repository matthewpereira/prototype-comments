(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))c(n);new MutationObserver(n=>{for(const t of n)if(t.type==="childList")for(const s of t.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&c(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const t={};return n.integrity&&(t.integrity=n.integrity),n.referrerPolicy&&(t.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?t.credentials="include":n.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function c(n){if(n.ep)return;n.ep=!0;const t=o(n);fetch(n.href,t)}})();const X="prototype-comments";function w(){return typeof window<"u"&&typeof document<"u"}function W(){if(!w()||!("localStorage"in window))return!1;try{const d=`${X}:__test`;window.localStorage.setItem(d,"1");const e=window.localStorage.getItem(d)==="1";return window.localStorage.removeItem(d),e}catch{return!1}}function F(){let d=[];return{load:()=>[...d],save:e=>{d=[...e]},clear:()=>{d=[]}}}function j(){return{load:()=>{if(!w()||!("localStorage"in window))return[];try{const d=window.localStorage.getItem(X);if(!d)return[];const e=JSON.parse(d);return Array.isArray(e)?e:[]}catch{return[]}},save:d=>{if(!(!w()||!("localStorage"in window)))try{window.localStorage.setItem(X,JSON.stringify(d))}catch{}},clear:()=>{if(!(!w()||!("localStorage"in window)))try{window.localStorage.removeItem(X)}catch{}}}}function J(d){if(d.id)return`#${d.id}`;const e=[];let o=d;for(;o&&o.nodeType===1&&o!==document.body;){let n=o.tagName.toLowerCase();o.classList.length&&(n+="."+Array.from(o.classList).slice(0,2).join("."));const t=o.parentElement;if(t){const m=Array.from(t.children).filter(i=>i.tagName===o.tagName).indexOf(o)+1;n+=`:nth-of-type(${m})`}e.unshift(n),o=o.parentElement}return e.join(" > ")}function _(d){if(!w()||!d)return null;try{return d.startsWith("#"),document.querySelector(d)}catch{return null}}function Z(){if(typeof document>"u"||document.getElementById("prototype-comments-tokens"))return;const d=document.createElement("style");d.id="prototype-comments-tokens",d.textContent=`
    :root {
      --prototype-comments-min-width: 250px;
      --prototype-comments-max-width: 400px;
      --prototype-comments-min-height: 24px;
      --prototype-comments-proximity: 256px;
      /* theme tokens populated at runtime on the overlay */
      --pc-bg: rgba(255,255,255,0.85);
      --pc-bg-hover: rgba(255,255,255,0.95);
      --pc-border-color: rgba(0,0,0,0.25);
      --pc-text: #111827;
      --pc-collapsed-bg: rgba(255,255,255,1);
    }
  `,document.head.appendChild(d)}class G{isEnabled=!1;storage=F();comments=[];overlayElement=null;editorElement=null;exportAs="json";debug=!0;storageKind="memory";hoverHandler=null;viewportHandler=null;keyHandler=null;visible=!0;theme="dark";collapseTimers=new WeakMap;setDebug(e){this.debug=e,this.debugLog("debug logging",e?"enabled":"disabled")}debugLog(...e){this.debug&&console.log("[prototype-comments]",...e)}applyThemeVars(){if(!this.overlayElement)return;const e=this.overlayElement,o=this.theme==="light",c=o?"rgba(0,0,0,0.80)":"rgba(255,255,255,0.85)",n=o?"rgba(255,255,255,0.55)":"rgba(0,0,0,0.25)",t=o?"#f9fafb":"#111827",s=o?"rgba(0,0,0,0.90)":"rgba(255,255,255,1)";e.style.setProperty("--pc-bg",c),e.style.setProperty("--pc-border-color",n),e.style.setProperty("--pc-text",t),e.style.setProperty("--pc-collapsed-bg",s)}setTheme(e){this.theme=e,this.applyThemeVars(),this.renderOverlay()}enable(e={}){if(this.setDebug(e.debug??this.debug),this.debugLog("enable() called with options:",{storage:e.storage??"memory",exportFormat:e.exportFormat??"json",theme:e.theme??this.theme}),!w()){this.storage=F(),this.comments=[],this.exportAs=e.exportFormat??"json",this.isEnabled=!0,this.storageKind="memory",this.theme=e.theme??this.theme,this.debugLog("enabled in non-browser environment with memory storage");return}this.exportAs=e.exportFormat??"json",this.theme=e.theme??this.theme;const o=e.storage??"memory";o==="localStorage"&&W()?(this.storage=j(),this.storageKind="localStorage",this.debugLog("using localStorage backend")):(o==="localStorage"&&this.debugLog("localStorage unavailable; falling back to memory storage"),this.storage=F(),this.storageKind="memory"),this.comments=this.storage.load(),this.ensureOverlay(),Z(),this.overlayElement&&(this.overlayElement.style.display=this.visible?"":"none"),this.applyThemeVars(),this.renderOverlay(),this.attachKeyHandler(),this.isEnabled=!0,this.debugLog("enabled with",this.storageKind,"storage; comments loaded:",this.comments.length)}disable(){if(this.debugLog("disable() called"),!this.isEnabled){this.debugLog("already disabled; no action taken");return}this.teardownOverlay(),this.isEnabled=!1,this.debugLog("disabled successfully")}export(){return this.debugLog("export() called; format:",this.exportAs,"count:",this.comments.length),this.exportAs==="markdown"?this.toMarkdown(this.comments):this.toJson(this.comments)}getAll(){return this.debugLog("getAll() called; count:",this.comments.length),[...this.comments]}addComment(e){const o={id:e.id??Math.random().toString(36).slice(2),text:e.text,x:e.x,y:e.y,timestamp:e.timestamp??Date.now(),nx:e.nx,ny:e.ny,anchor:e.anchor};return this.comments.push(o),this.persist(),this.renderOverlay(),this.debugLog("addComment() created:",{id:o.id,x:o.x,y:o.y,text:o.text}),this.debugLog("total comments after add:",this.comments.length),o}clear(){this.debugLog("clear() called; removing comments:",this.comments.length),this.comments=[],this.storage.clear(),this.renderOverlay(),this.debugLog("all comments cleared")}deleteById(e){const o=this.comments.length;this.comments=this.comments.filter(c=>c.id!==e),this.comments.length!==o&&(this.persist(),this.renderOverlay(),this.debugLog("deleteById() removed",e))}openEditorFor(e){if(!w())return;const o=this.comments.find(a=>a.id===e);if(!o)return;this.ensureOverlay(),this.removeEditor();const c=o.x-window.scrollX,n=o.y-window.scrollY,t=document.createElement("div");t.setAttribute("data-prototype-comment-editor",""),t.style.position="absolute",t.style.left=`${c}px`,t.style.top=`${n}px`,t.style.transform="translate(-50%, -50%)",t.style.background="var(--pc-bg, rgba(255,255,255,0.95))",t.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",t.style.borderRadius="16px",t.style.padding="12px",t.style.minWidth="var(--prototype-comments-min-width, 520px)",t.style.maxWidth="var(--prototype-comments-max-width, 520px)",t.style.boxShadow="0 6px 20px rgba(0,0,0,0.18)",t.style.pointerEvents="auto",t.style.display="flex",t.style.flexDirection="column",t.style.gap="8px",t.style.zIndex="2147483647";const s=document.createElement("textarea");s.placeholder="Edit comment…",s.value=o.text,s.style.resize="none",s.style.width="100%",s.style.background="var(--pc-bg, rgba(255,255,255,0.95))",s.style.height="72px",s.style.font="14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",s.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",s.style.borderRadius="8px",s.style.padding="8px",s.style.boxSizing="border-box",s.style.outline="none";const m=document.createElement("div");m.style.display="flex",m.style.justifyContent="flex-end",m.style.gap="8px";const i=document.createElement("button");i.textContent="Discard changes",i.style.cursor="pointer",i.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",i.style.borderRadius="8px",i.style.padding="6px 12px",i.style.background="var(--pc-bg, rgba(255,255,255,0.85))",i.style.color="var(--pc-text, #111827)",i.style.font="13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";const u=document.createElement("button");u.textContent="Edit",u.style.cursor="pointer",u.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",u.style.borderRadius="8px",u.style.padding="6px 12px",u.style.background="#111827",u.style.color="white",u.style.font="13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";const p=()=>{const a=s.value.trim();if(a.length===0){this.debugLog("openEditorFor() submit ignored; empty text");return}const v=this.comments.findIndex(x=>x.id===e);v>=0&&(this.comments[v]={...this.comments[v],text:a},this.persist(),this.renderOverlay()),this.removeEditor()};i.addEventListener("click",()=>{this.removeEditor()}),u.addEventListener("click",p),s.addEventListener("keydown",a=>{const v=a;v.key==="Enter"&&(v.metaKey||v.ctrlKey)||v.key==="Enter"&&!v.shiftKey?(v.preventDefault(),p()):v.key==="Escape"&&(v.preventDefault(),this.removeEditor())}),m.appendChild(i),m.appendChild(u),t.appendChild(s),t.appendChild(m),t.addEventListener("click",a=>a.stopPropagation()),this.editorElement=t,this.overlayElement&&this.overlayElement.appendChild(t),setTimeout(()=>s.focus(),0)}beginCommentAt(e,o,c){if(this.debugLog("beginCommentAt() at",{x:e,y:o}),!w())return;this.ensureOverlay(),this.removeEditor();const n=document.createElement("div");n.setAttribute("data-prototype-comment-editor",""),n.style.position="absolute",n.style.left=`${e}px`,n.style.top=`${o}px`,n.style.transform="translate(-50%, -50%)",n.style.background="var(--pc-bg, rgba(255,255,255,0.85))",n.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",n.style.borderRadius="16px",n.style.padding="12px",n.style.minWidth="var(--prototype-comments-min-width, 400px)",n.style.maxWidth="var(--prototype-comments-max-width, 400px)",n.style.boxShadow="0 6px 20px rgba(0,0,0,0.18)",n.style.pointerEvents="auto",n.style.display="flex",n.style.flexDirection="column",n.style.gap="8px",n.style.zIndex="2147483647";const t=document.createElement("textarea");t.placeholder="Add a comment…",t.style.resize="none",t.style.width="100%",t.style.height="72px",t.style.background="var(--pc-bg, rgba(255,255,255,0.55))",t.style.font="14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",t.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",t.style.borderRadius="8px",t.style.padding="8px",t.style.boxSizing="border-box",t.style.outline="none";const s=document.createElement("div");s.style.display="flex",s.style.justifyContent="flex-end",s.style.gap="8px";const m=document.createElement("button");m.textContent="Cancel",m.style.cursor="pointer",m.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",m.style.borderRadius="8px",m.style.padding="6px 12px",m.style.background="var(--pc-bg, rgba(255,255,255,0.85))",m.style.color="var(--pc-text, #111827)",m.style.font="13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";const i=document.createElement("button");i.textContent="Add",i.style.cursor="pointer",i.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",i.style.borderRadius="8px",i.style.padding="6px 12px",i.style.background="#111827",i.style.color="white",i.style.font="13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",i.addEventListener("mouseenter",()=>{i.style.background="#111827",i.style.color="white"}),i.addEventListener("mouseleave",()=>{i.style.background="#111827",i.style.color="white"}),i.addEventListener("mousedown",()=>{i.style.transform="scale(0.98)"}),i.addEventListener("mouseup",()=>{i.style.transform="translateZ(0)"});const u=()=>{const f=t.value.trim();if(f.length===0){this.debugLog("beginCommentAt() submit ignored; empty text");return}const y=parseFloat(n.style.left),k=parseFloat(n.style.top);this.removeEditor();const S=y+(w()?window.scrollX:0),b=k+(w()?window.scrollY:0),L=w()?Math.max(1,window.innerWidth):1,z=w()?Math.max(1,window.innerHeight):1,Y=S/L,P=b/z;let M;if(w()){let g=null;if(c?.anchor)g=typeof c.anchor=="string"?document.querySelector(c.anchor):c.anchor;else{const E=n.style.pointerEvents;n.style.pointerEvents="none";try{g=document.elementFromPoint(y,k)}finally{n.style.pointerEvents=E}}if(g&&g.closest("[data-prototype-comments-overlay]")&&(g=g.parentElement),g){const E=g.getBoundingClientRect(),l=E.width>0?(y-E.left)/E.width:.5,r=E.height>0?(k-E.top)/E.height:.5;M={path:this.getElementPath(g),rx:Math.min(Math.max(l,0),1),ry:Math.min(Math.max(r,0),1)}}}this.addComment({text:f,x:S,y:b,nx:Y,ny:P,anchor:M})};m.addEventListener("click",()=>{this.debugLog("beginCommentAt() cancelled"),this.removeEditor()}),i.addEventListener("click",u),t.addEventListener("keydown",f=>{const y=f;y.key==="Enter"&&(y.metaKey||y.ctrlKey)||y.key==="Enter"&&!y.shiftKey?(y.preventDefault(),u()):y.key==="Escape"&&(y.preventDefault(),this.removeEditor())}),s.appendChild(m),s.appendChild(i),n.appendChild(t),n.appendChild(s);const p=document.createElement("div");p.setAttribute("data-prototype-comment-handle",""),p.title="Drag to move",p.style.position="absolute",p.style.top="6px",p.style.right="6px",p.style.width="12px",p.style.height="12px",p.style.borderRadius="3px",p.style.background="#e5e7eb",p.style.boxShadow="inset 0 0 0 1px rgba(0,0,0,0.15)",p.style.cursor="grab",p.style.pointerEvents="auto";let a=!1,v=0,x=0;const B=f=>{if(!a)return;const y=f.clientX,k=f.clientY,S=y-v,b=k-x;n.style.left=`${S}px`,n.style.top=`${b}px`},h=()=>{a&&(a=!1,window.removeEventListener("mousemove",B),window.removeEventListener("mouseup",h),p.style.cursor="grab")};p.addEventListener("mousedown",f=>{f.preventDefault(),f.stopPropagation(),a=!0,p.style.cursor="grabbing";const y=parseFloat(n.style.left),k=parseFloat(n.style.top),S=f.clientX,b=f.clientY;v=S-y,x=b-k,window.addEventListener("mousemove",B,{passive:!0}),window.addEventListener("mouseup",h)}),n.appendChild(p),n.addEventListener("click",f=>f.stopPropagation()),this.editorElement=n,this.overlayElement&&this.overlayElement.appendChild(n),setTimeout(()=>t.focus(),0)}removeEditor(){if(!this.editorElement)return;const e=this.editorElement.parentElement;e&&e.removeChild(this.editorElement),this.editorElement=null}persist(){this.debugLog("persist() saving to",this.storageKind,"count:",this.comments.length),this.storage.save(this.comments)}ensureOverlay(){if(!w()||this.overlayElement)return;const e=document.createElement("div");e.setAttribute("data-prototype-comments-overlay",""),e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.pointerEvents="none",e.style.zIndex="2147483647",e.style.fontFamily="system-ui, -apple-system, Segoe UI, Roboto, sans-serif",e.style.display=this.visible?"":"none",document.body.appendChild(e),this.overlayElement=e,this.debugLog("overlay created"),this.attachHoverTracking(),this.attachViewportHandlers()}teardownOverlay(){if(!this.overlayElement)return;const e=this.overlayElement.parentElement;e&&e.removeChild(this.overlayElement),this.overlayElement=null,this.debugLog("overlay removed"),this.detachHoverTracking(),this.detachViewportHandlers(),this.detachKeyHandler()}renderOverlay(){if(!this.overlayElement)return;const e=this.overlayElement;this.bubbleById=this.bubbleById??new Map;const o=this.bubbleById,c=new Set;for(const t of this.comments){let s=o.get(t.id);const m=!s;s||(s=document.createElement("div"),o.set(t.id,s),e.appendChild(s)),s.setAttribute("data-prototype-comment",t.id),s.title=t.text,s.style.position="absolute",s.style.transform="translate(-50%, -100%) scale(0.9)";let i,u;if(t.anchor&&w()){const g=this.resolveElementByPath(t.anchor.path);if(g){const E=g.getBoundingClientRect();i=E.left+t.anchor.rx*E.width,u=E.top+t.anchor.ry*E.height}else i=t.x-window.scrollX,u=t.y-window.scrollY}else i=t.x-(w()?window.scrollX:0),u=t.y-(w()?window.scrollY:0);s.style.left=`${i}px`,s.style.top=`${u}px`,m&&(s.style.font="13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",s.style.background="var(--pc-collapsed-bg, rgba(255,255,255,0.85))",s.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",s.style.boxShadow="0 6px 18px rgba(0,0,0,0.12)",s.style.pointerEvents="none",s.style.color="var(--pc-text, #111827)",s.style.overflow="hidden",s.style.width="24px",s.style.height="24px",s.style.minWidth="24px",s.style.maxWidth="24px",s.style.borderRadius="9999px",s.style.padding="0",s.style.transition="min-width 50ms cubic-bezier(0.22, 1, 0.36, 1), max-width 50ms cubic-bezier(0.22, 1, 0.36, 1), width 420ms cubic-bezier(0.22, 1, 0.36, 1), height 420ms cubic-bezier(0.22, 1, 0.36, 1), padding 420ms cubic-bezier(0.22, 1, 0.36, 1), border-radius 150ms cubic-bezier(0.22, 1, 0.36, 1), transform 420ms cubic-bezier(0.22, 1, 0.36, 1)",s.dataset.state="collapsed"),s.dataset.x=String(t.x),s.dataset.y=String(t.y);let a=s.querySelector("[data-prototype-comment-meta]");const v=!a;a||(a=document.createElement("div")),a.style.fontSize="11px",a.style.color="#555",a.textContent=this.formatTimestamp(t.timestamp),a.setAttribute("data-prototype-comment-meta",""),v&&(a.style.opacity="0",a.style.maxHeight="0px",a.style.marginBottom="0px",a.style.overflow="hidden",a.style.transform="translateY(-2px)",a.style.transition="opacity 420ms cubic-bezier(0.22, 1, 0.36, 1), max-height 420ms cubic-bezier(0.22, 1, 0.36, 1), margin-bottom 420ms cubic-bezier(0.22, 1, 0.36, 1), transform 420ms cubic-bezier(0.22, 1, 0.36, 1)",a.style.display="none");let x=s.querySelector("[data-prototype-comment-text]");const B=!x;x||(x=document.createElement("div")),x.setAttribute("data-prototype-comment-text",""),x.style.whiteSpace="nowrap",x.style.textOverflow="ellipsis",x.style.overflow="hidden",x.textContent=t.text,B&&(x.style.display="none",x.style.paddingBottom="4px",x.style.paddingTop="2px",x.style.opacity="0",x.style.transform="translateY(2px)",x.style.transition="opacity 250ms cubic-bezier(0.22, 1, 0.36, 1), transform 420ms cubic-bezier(0.22, 1, 0.36, 1)");let h=s.querySelector("[data-prototype-comment-actions]");const f=!h;h||(h=document.createElement("div")),h.setAttribute("data-prototype-comment-actions",""),h.style.display="flex",h.style.gap="8px",h.style.fontSize="11px",h.style.color="#1f2937",f&&(h.style.opacity="0",h.style.maxHeight="0px",h.style.marginTop="0px",h.style.overflow="hidden",h.style.transform="translateY(2px)",h.style.transition="opacity 420ms cubic-bezier(0.22, 1, 0.36, 1), max-height 420ms cubic-bezier(0.22, 1, 0.36, 1), margin-top 420ms cubic-bezier(0.22, 1, 0.36, 1), transform 420ms cubic-bezier(0.22, 1, 0.36, 1)",h.style.pointerEvents="auto",h.style.display="none");const y=g=>{g.href="#",g.style.color="#2563eb",g.style.textDecoration="none",g.style.cursor="pointer"};let k=h.querySelector("a[data-pc-edit]");k||(k=document.createElement("a"),k.setAttribute("data-pc-edit",""),h.appendChild(k)),k.textContent="Edit",y(k),k.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),this.openEditorFor(t.id)});let S=h.querySelector("a[data-pc-delete]");S||(S=document.createElement("a"),S.setAttribute("data-pc-delete",""),h.appendChild(S)),S.textContent="Delete",y(S),S.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),this.deleteById(t.id)});let b=s.querySelector("[data-prototype-comment-handle]");b||(b=document.createElement("div")),b.setAttribute("data-prototype-comment-handle",""),b.title="Drag to move",b.style.position="absolute",b.style.top="6px",b.style.right="6px",b.style.width="12px",b.style.height="12px",b.style.borderRadius="3px",b.style.background="#e5e7eb",b.style.boxShadow="inset 0 0 0 1px rgba(0,0,0,0.15)",b.style.cursor="grab",b.style.opacity="0",b.style.transition="opacity 120ms ease",b.style.pointerEvents="auto",b.style.display="none";let L=!1,z=0,Y=0;const P=g=>{if(!L)return;const E=g.clientX,l=g.clientY,r=E-z,C=l-Y;s.style.left=`${r}px`,s.style.top=`${C}px`},M=g=>{if(!L)return;L=!1,window.removeEventListener("mousemove",P),window.removeEventListener("mouseup",M),b.style.cursor="grab";const E=parseFloat(s.style.left),l=parseFloat(s.style.top),r=E+(w()?window.scrollX:0),C=l+(w()?window.scrollY:0),A=this.comments.findIndex(H=>H.id===t.id);if(A>=0){const H=w()?Math.max(1,window.innerWidth):1,O=w()?Math.max(1,window.innerHeight):1;let R;if(w())try{const I=this.overlayElement?.style.pointerEvents;this.overlayElement&&(this.overlayElement.style.pointerEvents="none");const V=document.elementFromPoint(E,l);this.overlayElement&&(this.overlayElement.style.pointerEvents=I??"");let $=V;if($&&$.closest("[data-prototype-comments-overlay]")&&($=$.parentElement),$){const D=$.getBoundingClientRect(),q=D.width>0?(E-D.left)/D.width:.5,N=D.height>0?(l-D.top)/D.height:.5;R={path:this.getElementPath($),rx:Math.min(Math.max(q,0),1),ry:Math.min(Math.max(N,0),1)}}}catch{}this.comments[A]={...this.comments[A],x:r,y:C,nx:r/H,ny:C/O,anchor:R},this.persist(),this.renderOverlay()}};b.addEventListener("mousedown",g=>{g.preventDefault(),g.stopPropagation(),L=!0,b.style.cursor="grabbing";const E=parseFloat(s.style.left),l=parseFloat(s.style.top),r=g.clientX,C=g.clientY;z=r-E,Y=C-l,window.addEventListener("mousemove",P,{passive:!0}),window.addEventListener("mouseup",M)}),m&&(s.appendChild(a),s.appendChild(x),s.appendChild(h),s.appendChild(b)),c.add(t.id)}const n=this.bubbleById;for(const[t,s]of n.entries())if(!c.has(t)){const m=s.parentElement;m&&m.removeChild(s),n.delete(t)}this.editorElement&&e.appendChild(this.editorElement),this.debugLog("renderOverlay() rendered markers:",this.comments.length)}toJson(e){return e.map(o=>({id:o.id,text:o.text,x:o.x,y:o.y,timestamp:o.timestamp}))}toMarkdown(e){if(e.length===0)return"";const o=["# Comments",""];for(const c of e){const n=new Date(c.timestamp).toISOString();o.push(`- (${c.x}, ${c.y}) ${this.escapeMarkdown(c.text)} — ${n}`)}return o.join(`
`)}escapeMarkdown(e){return e.replace(/[\\`*_{}\[\]()#+\-.!|]/g,o=>`\\${o}`)}previewText(e){const o=e.trim();return o.length<=40?o:o.slice(0,37)+"…"}formatTimestamp(e){try{return new Date(e).toLocaleString()}catch{return new Date(e).toISOString()}}attachHoverTracking(){this.hoverHandler||!w()||(this.hoverHandler=e=>{if(!this.overlayElement)return;const o=e.clientX,c=e.clientY,n=this.overlayElement.querySelectorAll("[data-prototype-comment]");for(const t of n){const s=t.getBoundingClientRect(),m=o>=s.left&&o<=s.right&&c>=s.top&&c<=s.bottom,i=t.querySelector("[data-prototype-comment-meta]"),u=t.querySelector("[data-prototype-comment-actions]"),p=t.querySelector("[data-prototype-comment-text]"),a=s.left+s.width/2,v=s.top+s.height/2;if(Math.hypot(o-a,c-v)<=256){t.style.minWidth="var(--prototype-comments-min-width, 250px)",t.style.minHeight="var(--prototype-comments-min-height, 24px)",t.style.maxWidth="var(--prototype-comments-max-width, 400px)",t.style.width="",t.style.height="",t.style.borderRadius="16px",t.style.padding="8px 12px",t.style.background="var(--pc-bg, rgba(255,255,255,0.85))",t.style.transform="translate(-50%, -100%) scale(1)";const f=this.collapseTimers.get(t);f&&(clearTimeout(f),this.collapseTimers.delete(t)),t.dataset.state="expanded",p&&(p.style.display="block",p.style.whiteSpace="normal",p.style.textOverflow="clip",p.style.overflow="visible",p.style.opacity!=="1"&&(p.style.opacity="0",p.style.transform="translateY(2px)",p.offsetWidth,requestAnimationFrame(()=>{p.style.opacity="1",p.style.transform="translateY(0)"})))}else if(!this.collapseTimers.has(t)){const f=window.setTimeout(()=>{if(t.style.width="24px",t.style.height="24px",t.style.minWidth="24px",t.style.maxWidth="24px",t.style.borderRadius="9999px",t.style.padding="0",t.style.transform="translate(-50%, -100%) scale(0.9)",t.dataset.state="collapsed",p){p.style.opacity="0",p.style.transform="translateY(2px)";const y=()=>{t.dataset.state==="collapsed"&&(p.style.display="none"),p.removeEventListener("transitionend",y)};p.addEventListener("transitionend",y),p.style.whiteSpace="nowrap",p.style.textOverflow="ellipsis",p.style.overflow="hidden"}this.collapseTimers.delete(t)},5e3);this.collapseTimers.set(t,f)}if(i)if(m)i.style.display="",i.style.opacity="1",i.style.maxHeight="20px",i.style.marginBottom="2px",i.style.transform="translateY(0)",t.style.background="var(--pc-bg, rgba(255,255,255,0.95))";else{i.style.opacity="0",i.style.maxHeight="0px",i.style.marginBottom="0px",i.style.transform="translateY(-2px)";const f=()=>{m||(i.style.display="none"),i.removeEventListener("transitionend",f)};i.addEventListener("transitionend",f)}if(u)if(m)u.style.display="flex",u.style.opacity="1",u.style.maxHeight="18px",u.style.marginTop="4px",u.style.transform="translateY(0)";else{u.style.opacity="0",u.style.maxHeight="0px",u.style.marginTop="0px",u.style.transform="translateY(2px)";const f=()=>{m||(u.style.display="none"),u.removeEventListener("transitionend",f)};u.addEventListener("transitionend",f),t.dataset.state==="expanded"&&(t.style.background="var(--pc-bg, rgba(255,255,255,0.85))")}const h=t.querySelector("[data-prototype-comment-handle]");h&&(h.style.opacity=m?"1":"0",h.style.display=m?"":"none")}},window.addEventListener("mousemove",this.hoverHandler,{passive:!0}))}detachHoverTracking(){this.hoverHandler&&(window.removeEventListener("mousemove",this.hoverHandler),this.hoverHandler=null)}attachViewportHandlers(){this.viewportHandler||!w()||(this.viewportHandler=()=>{this.renderOverlay()},window.addEventListener("scroll",this.viewportHandler,{passive:!0}),window.addEventListener("resize",this.viewportHandler,{passive:!0}))}detachViewportHandlers(){this.viewportHandler&&(window.removeEventListener("scroll",this.viewportHandler),window.removeEventListener("resize",this.viewportHandler),this.viewportHandler=null)}getElementPath(e){return J(e)}resolveElementByPath(e){return _(e)}attachKeyHandler(){this.keyHandler||!w()||(this.keyHandler=e=>{const o=e.key?.toLowerCase?.(),c=e.code;if(!o&&!c||(s=>{const m=s,i=m&&m.nodeType===3?m.parentElement:m;if(!i)return!1;if(i.tagName==="INPUT"||i.tagName==="TEXTAREA")return!0;let u=i;for(;u;){if(u.isContentEditable)return!0;u=u.parentElement}return!1})(e.target))return;(e.shiftKey&&(o==="c"||c==="KeyC"))===!0&&this.toggleVisibility()},window.addEventListener("keydown",this.keyHandler),document.addEventListener("keydown",this.keyHandler))}detachKeyHandler(){this.keyHandler&&(window.removeEventListener("keydown",this.keyHandler),document.removeEventListener("keydown",this.keyHandler),this.keyHandler=null)}isVisible(){return this.visible}show(){this.visible=!0,this.overlayElement&&(this.overlayElement.style.display="");try{window.dispatchEvent(new CustomEvent("prototype-comments:visibility",{detail:{visible:!0}}))}catch{}}hide(){this.visible=!1,this.overlayElement&&(this.overlayElement.style.display="none");try{window.dispatchEvent(new CustomEvent("prototype-comments:visibility",{detail:{visible:!1}}))}catch{}}toggleVisibility(){this.visible?this.hide():this.show()}}const T=new G;function Q(d){T.enable(d)}function ee(d){T.setDebug(d)}function te(){return T.isEnabled===!0}function se(){if(!w())return()=>{};const d=document.querySelector("[data-prototype-comments-controls]");if(d)return()=>{const l=d.parentElement;l&&l.removeChild(d)};const e=document.createElement("div");e.setAttribute("data-prototype-comments-controls",""),e.style.position="fixed",e.style.left="50%",e.style.bottom="20px",e.style.transform="translateX(-50%)",e.style.zIndex="2147483647",e.style.display="flex",e.style.gap="8px",e.style.alignItems="center",e.style.background="rgba(255,255,255,0.1)",e.style.backdropFilter="saturate(180%) blur(8px)",e.style.border="1px solid rgba(0,0,0,0.25)",e.style.borderRadius="16px",e.style.padding="8px 8px",e.style.boxShadow="0 4px 16px rgba(0,0,0,0.12)";const o=l=>{const r=document.createElement("button");return r.textContent=l,r.style.cursor="pointer",r.style.border="1px solid rgba(0,0,0,0.25)",r.style.borderRadius="8px",r.style.padding="8px 12px",r.style.background="rgba(255,255,255,0.6)",r.style.color="#111827",r.style.font="14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",r.style.boxShadow="0 1px 2px rgba(0,0,0,0.06)",r.style.transition="background-color 150ms ease, box-shadow 150ms ease, transform 120ms ease, border-color 150ms ease, color 150ms ease",r.addEventListener("mouseenter",()=>{r.style.background="#f9fafb",r.style.boxShadow="0 2px 6px rgba(0,0,0,0.08)"}),r.addEventListener("mouseleave",()=>{r.style.background="rgba(255,255,255,0.6)",r.style.boxShadow="0 1px 2px rgba(0,0,0,0.06)"}),r.addEventListener("mousedown",()=>{r.style.transform="scale(0.98)"}),r.addEventListener("mouseup",()=>{r.style.transform="translateZ(0)"}),r},c=o("Add comment (C)");c.title="Shortcut: C";let n=!1;const t=()=>{c.textContent=n?"Click to place… (C)":"Add comment (C)";const l=n?"crosshair":"";document.body.style.cursor=l,document.documentElement.style.cursor=l;const r=document.querySelector("[data-prototype-comments-overlay]");r&&(r.style.cursor=l)},s=()=>{n&&(n=!1,t(),document.removeEventListener("click",m,!0))},m=l=>{if(!n)return;const r=l.target;if(r&&(r.closest("[data-prototype-comments-controls]")||r.closest("[data-prototype-comment-editor]")))return;const C=l.clientX,A=l.clientY;T.beginCommentAt(C,A),s()};c.addEventListener("click",l=>{l.stopPropagation(),n=!n,t(),n?document.addEventListener("click",m,!0):document.removeEventListener("click",m,!0)}),t();const i=o("Hide comments (Shift+C)");i.title="Shortcut: Shift+C";const u=()=>{i.textContent=T.isVisible()?"Hide comments (Shift+C)":"Show comments (Shift+C)"};u(),i.addEventListener("click",l=>{l.stopPropagation(),T.toggleVisibility(),u(),M()});const p=o("Clear"),a=o("Confirm");a.style.background="#111827",a.style.color="white",a.style.display="none",a.addEventListener("mouseenter",()=>{a.style.background="#111827",a.style.color="white"}),a.addEventListener("mouseleave",()=>{a.style.background="#111827",a.style.color="white"}),a.addEventListener("mousedown",()=>{a.style.transform="scale(0.98)"}),a.addEventListener("mouseup",()=>{a.style.transform="translateZ(0)"});const v=o("Cancel");v.style.display="none";let x=!1;const B=l=>{x=l,M(),u()};p.addEventListener("click",l=>{l.stopPropagation(),B(!0)}),v.addEventListener("click",l=>{l.stopPropagation(),B(!1)}),a.addEventListener("click",l=>{l.stopPropagation(),T.clear(),B(!1)});const h=document.createElement("div");h.style.position="relative";const f=o("Export Comments"),y=document.createElement("div");y.style.position="absolute",y.style.right="0",y.style.bottom="42px",y.style.display="none",y.style.background="rgba(255,255,255,0.98)",y.style.border="1px solid rgba(0,0,0,0.12)",y.style.borderRadius="12px",y.style.padding="8px",y.style.minWidth="200px",y.style.boxShadow="0 8px 24px rgba(0,0,0,0.12)";const k=l=>{const r=document.createElement("button");return r.textContent=l,r.style.width="100%",r.style.textAlign="left",r.style.cursor="pointer",r.style.border="none",r.style.borderRadius="8px",r.style.padding="8px 10px",r.style.background="transparent",r.style.color="#111827",r.style.font="14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",r.addEventListener("mouseenter",()=>{r.style.background="#f3f4f6"}),r.addEventListener("mouseleave",()=>{r.style.background="transparent"}),r},S=k("Export JSON"),b=k("Export Markdown"),L=k("Cancel");L.style.background="white",L.style.color="#111827",L.addEventListener("mouseenter",()=>{L.style.background="white",L.style.color="#111827"}),L.addEventListener("mouseleave",()=>{L.style.background="white",L.style.color="#111827"}),L.addEventListener("mousedown",()=>{L.style.transform="scale(0.98)"}),L.addEventListener("mouseup",()=>{L.style.transform="translateZ(0)"});const z=()=>{y.style.display=y.style.display==="none"?"block":"none"};f.addEventListener("click",l=>{l.stopPropagation(),z()}),S.addEventListener("click",()=>{const l=T.export(),r=(Array.isArray(l),l);P(r),y.style.display="none"}),b.addEventListener("click",()=>{const l=T.export();if(typeof l=="string")P(l);else{const r=[],C=l;if(C.length){r.push("# Comments","");for(const A of C){const H=new Date(A.timestamp).toISOString();r.push(`- (${A.x}, ${A.y}) ${String(A.text).replace(/[\\`*_{}\[\]()#+\-.!|]/g,O=>`\\${O}`)} — ${H}`)}}P(r.join(`
`))}y.style.display="none"}),L.addEventListener("click",()=>{y.style.display="none"}),y.appendChild(S),y.appendChild(b);const Y=document.createElement("div");Y.style.height="8px",y.appendChild(Y),y.appendChild(L),h.appendChild(f),h.appendChild(y);function P(l){const r=new Date,C=V=>String(V).padStart(2,"0"),A=`${r.getFullYear()}${C(r.getMonth()+1)}${C(r.getDate())}-${C(r.getHours())}${C(r.getMinutes())}${C(r.getSeconds())}`;let H,O;if(typeof l=="string")H=new Blob([l],{type:"text/markdown;charset=utf-8"}),O=`comments-${A}.md`;else{const V=JSON.stringify(l,null,2);H=new Blob([V],{type:"application/json;charset=utf-8"}),O=`comments-${A}.json`}const R=URL.createObjectURL(H),I=document.createElement("a");I.href=R,I.download=O,I.style.display="none",I.addEventListener("click",V=>V.stopPropagation(),{once:!0}),e.appendChild(I),I.click(),e.removeChild(I),URL.revokeObjectURL(R)}const M=()=>{const l=T.isVisible()&&te();if(i.style.display=x?"none":"",!l){h.style.display="none",p.style.display="none",v.style.display="none",a.style.display="none",c.style.display="none",s();return}h.style.display=x?"none":"",c.style.display=x?"none":"",x?(p.style.display="none",a.style.display="",v.style.display=""):(p.style.display="",a.style.display="none",v.style.display="none")};M();const g=()=>{u(),M(),T.isVisible()||s()};window.addEventListener("prototype-comments:visibility",g),window.addEventListener("keydown",l=>{const r=l.key.toLowerCase();(A=>{const H=A,O=H&&H.nodeType===3?H.parentElement:H;if(!O)return!1;if(O.tagName==="INPUT"||O.tagName==="TEXTAREA")return!0;let R=O;for(;R;){if(R.isContentEditable)return!0;R=R.parentElement}return!1})(l.target)||r==="c"&&!l.shiftKey&&(n=!n,t(),n?document.addEventListener("click",m,!0):document.removeEventListener("click",m,!0))}),e.appendChild(c),e.appendChild(h),e.appendChild(p),e.appendChild(a),e.appendChild(v),e.appendChild(i),document.body.appendChild(e);const E=l=>{y.style.display==="block"&&(y.style.display="none")};return window.addEventListener("click",E,!0),()=>{const l=e.parentElement;l&&l.removeChild(e),window.removeEventListener("click",E,!0),window.removeEventListener("prototype-comments:visibility",g)}}const U=T;ee(!0);Q({storage:"localStorage",exportFormat:"markdown",debug:!0});let K=!1;function ne(){const d=K?"crosshair":"";document.body.style.cursor=d,document.documentElement.style.cursor=d;const e=document.querySelector("[data-prototype-comments-overlay]");e&&(e.style.cursor=d)}se();window.addEventListener("keydown",d=>{if((c=>{if(!c)return!1;const n=c.nodeType===3?c.parentElement:c;if(!n)return!1;if(n.tagName==="INPUT"||n.tagName==="TEXTAREA")return!0;let t=n;for(;t;){if(t.isContentEditable)return!0;t=t.parentElement}return!1})(d.target))return;const o=d.key.toLowerCase();if(o==="c"&&!d.shiftKey)K=!K,ne();else if(o==="c"&&d.shiftKey){const c=U;c&&typeof c.toggleVisibility=="function"&&c.toggleVisibility()}});document.addEventListener("click",d=>{if(!K)return;const e=d.target;if(e&&e.closest&&(e.closest("header")||e.closest("[data-prototype-comment-editor]")))return;const o=d.clientX,c=d.clientY;U.beginCommentAt(o,c)});

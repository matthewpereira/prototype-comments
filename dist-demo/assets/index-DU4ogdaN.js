(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const t of o)if(t.type==="childList")for(const y of t.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&s(y)}).observe(document,{childList:!0,subtree:!0});function n(o){const t={};return o.integrity&&(t.integrity=o.integrity),o.referrerPolicy&&(t.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?t.credentials="include":o.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function s(o){if(o.ep)return;o.ep=!0;const t=n(o);fetch(o.href,t)}})();const z="prototype-comments";function v(){return typeof window<"u"&&typeof document<"u"}function F(){if(!v()||!("localStorage"in window))return!1;try{const h=`${z}:__test`;window.localStorage.setItem(h,"1");const e=window.localStorage.getItem(h)==="1";return window.localStorage.removeItem(h),e}catch{return!1}}function D(){let h=[];return{load:()=>[...h],save:e=>{h=[...e]},clear:()=>{h=[]}}}function N(){return{load:()=>{if(!v()||!("localStorage"in window))return[];try{const h=window.localStorage.getItem(z);if(!h)return[];const e=JSON.parse(h);return Array.isArray(e)?e:[]}catch{return[]}},save:h=>{if(!(!v()||!("localStorage"in window)))try{window.localStorage.setItem(z,JSON.stringify(h))}catch{}},clear:()=>{if(!(!v()||!("localStorage"in window)))try{window.localStorage.removeItem(z)}catch{}}}}class U{isEnabled=!1;storage=D();comments=[];overlayElement=null;editorElement=null;exportAs="json";debug=!0;storageKind="memory";hoverHandler=null;viewportHandler=null;keyHandler=null;visible=!0;theme="dark";collapseTimers=new WeakMap;setDebug(e){this.debug=e,this.debugLog("debug logging",e?"enabled":"disabled")}debugLog(...e){this.debug&&console.log("[prototype-comments]",...e)}applyThemeVars(){if(!this.overlayElement)return;const e=this.overlayElement,n=this.theme==="light",s=n?"rgba(0,0,0,0.80)":"rgba(255,255,255,0.85)",o=n?"rgba(255,255,255,0.55)":"rgba(0,0,0,0.25)",t=n?"#f9fafb":"#111827",y=n?"rgba(0,0,0,0.90)":"rgba(255,255,255,1)";e.style.setProperty("--pc-bg",s),e.style.setProperty("--pc-border-color",o),e.style.setProperty("--pc-text",t),e.style.setProperty("--pc-collapsed-bg",y)}setTheme(e){this.theme=e,this.applyThemeVars(),this.renderOverlay()}enable(e={}){if(this.setDebug(e.debug??this.debug),this.debugLog("enable() called with options:",{storage:e.storage??"memory",exportFormat:e.exportFormat??"json",theme:e.theme??this.theme}),!v()){this.storage=D(),this.comments=[],this.exportAs=e.exportFormat??"json",this.isEnabled=!0,this.storageKind="memory",this.theme=e.theme??this.theme,this.debugLog("enabled in non-browser environment with memory storage");return}this.exportAs=e.exportFormat??"json",this.theme=e.theme??this.theme;const n=e.storage??"memory";n==="localStorage"&&F()?(this.storage=N(),this.storageKind="localStorage",this.debugLog("using localStorage backend")):(n==="localStorage"&&this.debugLog("localStorage unavailable; falling back to memory storage"),this.storage=D(),this.storageKind="memory"),this.comments=this.storage.load(),this.ensureOverlay(),this.overlayElement&&(this.overlayElement.style.display=this.visible?"":"none"),this.applyThemeVars(),this.renderOverlay(),this.attachKeyHandler(),this.isEnabled=!0,this.debugLog("enabled with",this.storageKind,"storage; comments loaded:",this.comments.length)}disable(){if(this.debugLog("disable() called"),!this.isEnabled){this.debugLog("already disabled; no action taken");return}this.teardownOverlay(),this.isEnabled=!1,this.debugLog("disabled successfully")}export(){return this.debugLog("export() called; format:",this.exportAs,"count:",this.comments.length),this.exportAs==="markdown"?this.toMarkdown(this.comments):this.toJson(this.comments)}getAll(){return this.debugLog("getAll() called; count:",this.comments.length),[...this.comments]}addComment(e){const n={id:e.id??Math.random().toString(36).slice(2),text:e.text,x:e.x,y:e.y,timestamp:e.timestamp??Date.now(),nx:e.nx,ny:e.ny,anchor:e.anchor};return this.comments.push(n),this.persist(),this.renderOverlay(),this.debugLog("addComment() created:",{id:n.id,x:n.x,y:n.y,text:n.text}),this.debugLog("total comments after add:",this.comments.length),n}clear(){this.debugLog("clear() called; removing comments:",this.comments.length),this.comments=[],this.storage.clear(),this.renderOverlay(),this.debugLog("all comments cleared")}deleteById(e){const n=this.comments.length;this.comments=this.comments.filter(s=>s.id!==e),this.comments.length!==n&&(this.persist(),this.renderOverlay(),this.debugLog("deleteById() removed",e))}openEditorFor(e){if(!v())return;const n=this.comments.find(m=>m.id===e);if(!n)return;this.ensureOverlay(),this.removeEditor();const s=n.x-window.scrollX,o=n.y-window.scrollY,t=document.createElement("div");t.setAttribute("data-prototype-comment-editor",""),t.style.position="absolute",t.style.left=`${s}px`,t.style.top=`${o}px`,t.style.transform="translate(-50%, -50%)",t.style.background="var(--pc-bg, rgba(255,255,255,0.95))",t.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",t.style.borderRadius="16px",t.style.padding="12px",t.style.minWidth="var(--prototype-comments-min-width, 520px)",t.style.maxWidth="var(--prototype-comments-max-width, 520px)",t.style.boxShadow="0 6px 20px rgba(0,0,0,0.18)",t.style.pointerEvents="auto",t.style.display="flex",t.style.flexDirection="column",t.style.gap="8px",t.style.zIndex="2147483647";const y=document.createElement("textarea");y.placeholder="Edit comment…",y.value=n.text,y.style.resize="none",y.style.width="100%",y.style.background="var(--pc-bg, rgba(255,255,255,0.95))",y.style.height="72px",y.style.font="14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",y.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",y.style.borderRadius="8px",y.style.padding="8px",y.style.boxSizing="border-box",y.style.outline="none";const c=document.createElement("div");c.style.display="flex",c.style.justifyContent="flex-end",c.style.gap="8px";const r=document.createElement("button");r.textContent="Discard changes",r.style.cursor="pointer",r.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",r.style.borderRadius="8px",r.style.padding="6px 12px",r.style.background="var(--pc-bg, rgba(255,255,255,0.85))",r.style.color="var(--pc-text, #111827)",r.style.font="13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";const a=document.createElement("button");a.textContent="Edit",a.style.cursor="pointer",a.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",a.style.borderRadius="8px",a.style.padding="6px 12px",a.style.background="#111827",a.style.color="white",a.style.font="13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";const l=()=>{const m=y.value.trim();if(m.length===0){this.debugLog("openEditorFor() submit ignored; empty text");return}const b=this.comments.findIndex(g=>g.id===e);b>=0&&(this.comments[b]={...this.comments[b],text:m},this.persist(),this.renderOverlay()),this.removeEditor()};r.addEventListener("click",()=>{this.removeEditor()}),a.addEventListener("click",l),y.addEventListener("keydown",m=>{const b=m;b.key==="Enter"&&(b.metaKey||b.ctrlKey)||b.key==="Enter"&&!b.shiftKey?(b.preventDefault(),l()):b.key==="Escape"&&(b.preventDefault(),this.removeEditor())}),c.appendChild(r),c.appendChild(a),t.appendChild(y),t.appendChild(c),t.addEventListener("click",m=>m.stopPropagation()),this.editorElement=t,this.overlayElement&&this.overlayElement.appendChild(t),setTimeout(()=>y.focus(),0)}beginCommentAt(e,n,s){if(this.debugLog("beginCommentAt() at",{x:e,y:n}),!v())return;this.ensureOverlay(),this.removeEditor();const o=document.createElement("div");o.setAttribute("data-prototype-comment-editor",""),o.style.position="absolute",o.style.left=`${e}px`,o.style.top=`${n}px`,o.style.transform="translate(-50%, -50%)",o.style.background="var(--pc-bg, rgba(255,255,255,0.85))",o.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",o.style.borderRadius="16px",o.style.padding="12px",o.style.minWidth="var(--prototype-comments-min-width, 400px)",o.style.maxWidth="var(--prototype-comments-max-width, 400px)",o.style.boxShadow="0 6px 20px rgba(0,0,0,0.18)",o.style.pointerEvents="auto",o.style.display="flex",o.style.flexDirection="column",o.style.gap="8px",o.style.zIndex="2147483647";const t=document.createElement("textarea");t.placeholder="Add a comment…",t.style.resize="none",t.style.width="100%",t.style.height="72px",t.style.background="var(--pc-bg, rgba(255,255,255,0.55))",t.style.font="14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",t.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",t.style.borderRadius="8px",t.style.padding="8px",t.style.boxSizing="border-box",t.style.outline="none";const y=document.createElement("div");y.style.display="flex",y.style.justifyContent="flex-end",y.style.gap="8px";const c=document.createElement("button");c.textContent="Cancel",c.style.cursor="pointer",c.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",c.style.borderRadius="8px",c.style.padding="6px 12px",c.style.background="var(--pc-bg, rgba(255,255,255,0.85))",c.style.color="var(--pc-text, #111827)",c.style.font="13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";const r=document.createElement("button");r.textContent="Add",r.style.cursor="pointer",r.style.border="1px solid var(--pc-border-color, rgba(0,0,0,0.25))",r.style.borderRadius="8px",r.style.padding="6px 12px",r.style.background="#111827",r.style.color="white",r.style.font="13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",r.addEventListener("mouseenter",()=>{r.style.background="#111827",r.style.color="white"}),r.addEventListener("mouseleave",()=>{r.style.background="#111827",r.style.color="white"}),r.addEventListener("mousedown",()=>{r.style.transform="scale(0.98)"}),r.addEventListener("mouseup",()=>{r.style.transform="translateZ(0)"});const a=()=>{const f=t.value.trim();if(f.length===0){this.debugLog("beginCommentAt() submit ignored; empty text");return}const p=parseFloat(o.style.left),E=parseFloat(o.style.top);this.removeEditor();const u=p+(v()?window.scrollX:0),x=E+(v()?window.scrollY:0),w=v()?Math.max(1,window.innerWidth):1,Y=v()?Math.max(1,window.innerHeight):1,A=u/w,V=x/Y;let O;if(v()){let k=null;if(s?.anchor)k=typeof s.anchor=="string"?document.querySelector(s.anchor):s.anchor;else{const T=o.style.pointerEvents;o.style.pointerEvents="none";try{k=document.elementFromPoint(p,E)}finally{o.style.pointerEvents=T}}if(k&&k.closest("[data-prototype-comments-overlay]")&&(k=k.parentElement),k){const T=k.getBoundingClientRect(),d=T.width>0?(p-T.left)/T.width:.5,i=T.height>0?(E-T.top)/T.height:.5;O={path:this.getElementPath(k),rx:Math.min(Math.max(d,0),1),ry:Math.min(Math.max(i,0),1)}}}this.addComment({text:f,x:u,y:x,nx:A,ny:V,anchor:O})};c.addEventListener("click",()=>{this.debugLog("beginCommentAt() cancelled"),this.removeEditor()}),r.addEventListener("click",a),t.addEventListener("keydown",f=>{const p=f;p.key==="Enter"&&(p.metaKey||p.ctrlKey)||p.key==="Enter"&&!p.shiftKey?(p.preventDefault(),a()):p.key==="Escape"&&(p.preventDefault(),this.removeEditor())}),y.appendChild(c),y.appendChild(r),o.appendChild(t),o.appendChild(y);const l=document.createElement("div");l.setAttribute("data-prototype-comment-handle",""),l.title="Drag to move",l.style.position="absolute",l.style.top="6px",l.style.right="6px",l.style.width="12px",l.style.height="12px",l.style.borderRadius="3px",l.style.background="#e5e7eb",l.style.boxShadow="inset 0 0 0 1px rgba(0,0,0,0.15)",l.style.cursor="grab",l.style.pointerEvents="auto";let m=!1,b=0,g=0;const C=f=>{if(!m)return;const p=f.clientX,E=f.clientY,u=p-b,x=E-g;o.style.left=`${u}px`,o.style.top=`${x}px`},L=()=>{m&&(m=!1,window.removeEventListener("mousemove",C),window.removeEventListener("mouseup",L),l.style.cursor="grab")};l.addEventListener("mousedown",f=>{f.preventDefault(),f.stopPropagation(),m=!0,l.style.cursor="grabbing";const p=parseFloat(o.style.left),E=parseFloat(o.style.top),u=f.clientX,x=f.clientY;b=u-p,g=x-E,window.addEventListener("mousemove",C,{passive:!0}),window.addEventListener("mouseup",L)}),o.appendChild(l),o.addEventListener("click",f=>f.stopPropagation()),this.editorElement=o,this.overlayElement&&this.overlayElement.appendChild(o),setTimeout(()=>t.focus(),0)}removeEditor(){if(!this.editorElement)return;const e=this.editorElement.parentElement;e&&e.removeChild(this.editorElement),this.editorElement=null}persist(){this.debugLog("persist() saving to",this.storageKind,"count:",this.comments.length),this.storage.save(this.comments)}ensureOverlay(){if(!v()||this.overlayElement)return;const e=document.createElement("div");e.setAttribute("data-prototype-comments-overlay",""),e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.pointerEvents="none",e.style.zIndex="2147483647",e.style.fontFamily="system-ui, -apple-system, Segoe UI, Roboto, sans-serif",e.style.display=this.visible?"":"none",document.body.appendChild(e),this.overlayElement=e,this.debugLog("overlay created"),this.attachHoverTracking(),this.attachViewportHandlers()}teardownOverlay(){if(!this.overlayElement)return;const e=this.overlayElement.parentElement;e&&e.removeChild(this.overlayElement),this.overlayElement=null,this.debugLog("overlay removed"),this.detachHoverTracking(),this.detachViewportHandlers(),this.detachKeyHandler()}renderOverlay(){if(!this.overlayElement)return;const e=this.overlayElement;e.innerHTML="";for(const n of this.comments){const s=document.createElement("div");s.setAttribute("data-prototype-comment",n.id),s.title=n.text,s.style.position="absolute",s.style.transform="translate(-50%, -100%) scale(0.9)";let o,t;if(n.anchor&&v()){const u=this.resolveElementByPath(n.anchor.path);if(u){const x=u.getBoundingClientRect();o=x.left+n.anchor.rx*x.width,t=x.top+n.anchor.ry*x.height}else o=n.x-window.scrollX,t=n.y-window.scrollY}else o=n.x-(v()?window.scrollX:0),t=n.y-(v()?window.scrollY:0);s.style.left=`${o}px`,s.style.top=`${t}px`,s.style.font="13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",s.style.background="var(--pc-collapsed-bg, rgba(255,255,255,0.85))",s.style.border="4px solid var(rgba(0,0,0,0.5))",s.style.boxShadow="0 6px 18px rgba(0,0,0,0.12)",s.style.pointerEvents="none",s.style.color="var(--pc-text, #111827)",s.style.overflow="hidden",s.style.width="24px",s.style.height="24px",s.style.minWidth="24px",s.style.maxWidth="24px",s.style.borderRadius="9999px",s.style.padding="0",s.style.transition="min-width 50ms cubic-bezier(0.22, 1, 0.36, 1), max-width 50ms cubic-bezier(0.22, 1, 0.36, 1), width 420ms cubic-bezier(0.22, 1, 0.36, 1), height 420ms cubic-bezier(0.22, 1, 0.36, 1), padding 420ms cubic-bezier(0.22, 1, 0.36, 1), border-radius 150ms cubic-bezier(0.22, 1, 0.36, 1), transform 420ms cubic-bezier(0.22, 1, 0.36, 1)",s.dataset.state="collapsed",s.dataset.x=String(n.x),s.dataset.y=String(n.y);const c=document.createElement("div");c.style.fontSize="11px",c.style.color="#555",c.textContent=this.formatTimestamp(n.timestamp),c.setAttribute("data-prototype-comment-meta",""),c.style.opacity="0",c.style.maxHeight="0px",c.style.marginBottom="0px",c.style.overflow="hidden",c.style.transform="translateY(-2px)",c.style.transition="opacity 420ms cubic-bezier(0.22, 1, 0.36, 1), max-height 420ms cubic-bezier(0.22, 1, 0.36, 1), margin-bottom 420ms cubic-bezier(0.22, 1, 0.36, 1), transform 420ms cubic-bezier(0.22, 1, 0.36, 1)",c.style.display="none";const r=document.createElement("div");r.setAttribute("data-prototype-comment-text",""),r.style.whiteSpace="nowrap",r.style.textOverflow="ellipsis",r.style.overflow="hidden",r.textContent=n.text,r.style.display="none",r.style.paddingBottom="4px",r.style.paddingTop="2px",r.style.opacity="0",r.style.transform="translateY(2px)",r.style.transition="opacity 250ms cubic-bezier(0.22, 1, 0.36, 1), transform 420ms cubic-bezier(0.22, 1, 0.36, 1)";const a=document.createElement("div");a.setAttribute("data-prototype-comment-actions",""),a.style.display="flex",a.style.gap="8px",a.style.fontSize="11px",a.style.color="#1f2937",a.style.opacity="0",a.style.maxHeight="0px",a.style.marginTop="0px",a.style.overflow="hidden",a.style.transform="translateY(2px)",a.style.transition="opacity 420ms cubic-bezier(0.22, 1, 0.36, 1), max-height 420ms cubic-bezier(0.22, 1, 0.36, 1), margin-top 420ms cubic-bezier(0.22, 1, 0.36, 1), transform 420ms cubic-bezier(0.22, 1, 0.36, 1)",a.style.pointerEvents="auto",a.style.display="none";const l=u=>{u.href="#",u.style.color="#2563eb",u.style.textDecoration="none",u.style.cursor="pointer"},m=document.createElement("a");m.textContent="Edit",l(m),m.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),this.openEditorFor(n.id)});const b=document.createElement("a");b.textContent="Delete",l(b),b.addEventListener("click",u=>{u.preventDefault(),u.stopPropagation(),this.deleteById(n.id)}),a.appendChild(m),a.appendChild(b);const g=document.createElement("div");g.setAttribute("data-prototype-comment-handle",""),g.title="Drag to move",g.style.position="absolute",g.style.top="6px",g.style.right="6px",g.style.width="12px",g.style.height="12px",g.style.borderRadius="3px",g.style.background="#e5e7eb",g.style.boxShadow="inset 0 0 0 1px rgba(0,0,0,0.15)",g.style.cursor="grab",g.style.opacity="0",g.style.transition="opacity 120ms ease",g.style.pointerEvents="auto",g.style.display="none";let C=!1,L=0,f=0;const p=u=>{if(!C)return;const x=u.clientX,w=u.clientY,Y=x-L,A=w-f;s.style.left=`${Y}px`,s.style.top=`${A}px`},E=u=>{if(!C)return;C=!1,window.removeEventListener("mousemove",p),window.removeEventListener("mouseup",E),g.style.cursor="grab";const x=parseFloat(s.style.left),w=parseFloat(s.style.top),Y=x+(v()?window.scrollX:0),A=w+(v()?window.scrollY:0),V=this.comments.findIndex(O=>O.id===n.id);if(V>=0){const O=v()?Math.max(1,window.innerWidth):1,k=v()?Math.max(1,window.innerHeight):1;this.comments[V]={...this.comments[V],x:Y,y:A,nx:Y/O,ny:A/k},this.persist(),this.renderOverlay()}};g.addEventListener("mousedown",u=>{u.preventDefault(),u.stopPropagation(),C=!0,g.style.cursor="grabbing";const x=parseFloat(s.style.left),w=parseFloat(s.style.top),Y=u.clientX,A=u.clientY;L=Y-x,f=A-w,window.addEventListener("mousemove",p,{passive:!0}),window.addEventListener("mouseup",E)}),s.appendChild(c),s.appendChild(r),s.appendChild(a),s.appendChild(g),e.appendChild(s)}this.editorElement&&e.appendChild(this.editorElement),this.debugLog("renderOverlay() rendered markers:",this.comments.length)}toJson(e){return e.map(n=>({id:n.id,text:n.text,x:n.x,y:n.y,timestamp:n.timestamp}))}toMarkdown(e){if(e.length===0)return"";const n=["# Comments",""];for(const s of e){const o=new Date(s.timestamp).toISOString();n.push(`- (${s.x}, ${s.y}) ${this.escapeMarkdown(s.text)} — ${o}`)}return n.join(`
`)}escapeMarkdown(e){return e.replace(/[\\`*_{}\[\]()#+\-.!|]/g,n=>`\\${n}`)}previewText(e){const n=e.trim();return n.length<=40?n:n.slice(0,37)+"…"}formatTimestamp(e){try{return new Date(e).toLocaleString()}catch{return new Date(e).toISOString()}}attachHoverTracking(){this.hoverHandler||!v()||(this.hoverHandler=e=>{if(!this.overlayElement)return;const n=e.clientX,s=e.clientY,o=this.overlayElement.querySelectorAll("[data-prototype-comment]");for(const t of o){const y=t.getBoundingClientRect(),c=n>=y.left&&n<=y.right&&s>=y.top&&s<=y.bottom,r=t.querySelector("[data-prototype-comment-meta]"),a=t.querySelector("[data-prototype-comment-actions]"),l=t.querySelector("[data-prototype-comment-text]"),m=y.left+y.width/2,b=y.top+y.height/2;if(Math.hypot(n-m,s-b)<=256){t.style.minWidth="var(--prototype-comments-min-width, 250px)",t.style.minHeight="var(--prototype-comments-min-height, 24px)",t.style.maxWidth="var(--prototype-comments-max-width, 400px)",t.style.width="",t.style.height="",t.style.borderRadius="16px",t.style.padding="8px 12px",t.style.background="var(--pc-bg, rgba(255,255,255,0.85))",t.style.transform="translate(-50%, -100%) scale(1)";const f=this.collapseTimers.get(t);if(f&&(clearTimeout(f),this.collapseTimers.delete(t)),t.dataset.state!=="expanded"){t.dataset.state="expanding",l&&(l.style.display="none");const E=u=>{if(u&&u.target!==t)return;const x=u?.propertyName;x&&x!=="transform"&&x!=="width"&&x!=="max-width"&&x!=="min-width"||(t.dataset.state==="expanding"&&(t.dataset.state="expanded",l&&(l.style.display="block",l.style.whiteSpace="normal",l.style.textOverflow="clip",l.style.overflow="visible",l.style.opacity="0",l.style.transform="translateY(2px)",l.offsetWidth,requestAnimationFrame(()=>{l.style.opacity="1",l.style.transform="translateY(0)"}))),t.removeEventListener("transitionend",E))};t.addEventListener("transitionend",E)}else l&&(l.style.display="block",l.style.whiteSpace="normal",l.style.textOverflow="clip",l.style.overflow="visible",l.style.opacity="1",l.style.transform="translateY(0)")}else if(!this.collapseTimers.has(t)){const f=window.setTimeout(()=>{if(t.style.width="24px",t.style.height="24px",t.style.minWidth="24px",t.style.maxWidth="24px",t.style.borderRadius="9999px",t.style.padding="0",t.style.transform="translate(-50%, -100%) scale(0.9)",t.dataset.state="collapsed",l){l.style.opacity="0",l.style.transform="translateY(2px)";const p=()=>{t.dataset.state==="collapsed"&&(l.style.display="none"),l.removeEventListener("transitionend",p)};l.addEventListener("transitionend",p),l.style.whiteSpace="nowrap",l.style.textOverflow="ellipsis",l.style.overflow="hidden"}this.collapseTimers.delete(t)},220);this.collapseTimers.set(t,f)}if(r)if(c)r.style.display="",r.style.opacity="1",r.style.maxHeight="20px",r.style.marginBottom="2px",r.style.transform="translateY(0)";else{r.style.opacity="0",r.style.maxHeight="0px",r.style.marginBottom="0px",r.style.transform="translateY(-2px)";const f=()=>{c||(r.style.display="none"),r.removeEventListener("transitionend",f)};r.addEventListener("transitionend",f)}if(a)if(c)a.style.display="flex",a.style.opacity="1",a.style.maxHeight="18px",a.style.marginTop="4px",a.style.transform="translateY(0)";else{a.style.opacity="0",a.style.maxHeight="0px",a.style.marginTop="0px",a.style.transform="translateY(2px)";const f=()=>{c||(a.style.display="none"),a.removeEventListener("transitionend",f)};a.addEventListener("transitionend",f)}const L=t.querySelector("[data-prototype-comment-handle]");L&&(L.style.opacity=c?"1":"0",L.style.display=c?"":"none")}},window.addEventListener("mousemove",this.hoverHandler,{passive:!0}))}detachHoverTracking(){this.hoverHandler&&(window.removeEventListener("mousemove",this.hoverHandler),this.hoverHandler=null)}attachViewportHandlers(){this.viewportHandler||!v()||(this.viewportHandler=()=>{this.renderOverlay()},window.addEventListener("scroll",this.viewportHandler,{passive:!0}),window.addEventListener("resize",this.viewportHandler,{passive:!0}))}detachViewportHandlers(){this.viewportHandler&&(window.removeEventListener("scroll",this.viewportHandler),window.removeEventListener("resize",this.viewportHandler),this.viewportHandler=null)}getElementPath(e){if(e.id)return`#${e.id}`;const n=[];let s=e;for(;s&&s.nodeType===1&&s!==document.body;){let t=s.tagName.toLowerCase();s.classList.length&&(t+="."+Array.from(s.classList).slice(0,2).join("."));const y=s.parentElement;if(y){const r=Array.from(y.children).filter(a=>a.tagName===s.tagName).indexOf(s)+1;t+=`:nth-of-type(${r})`}n.unshift(t),s=s.parentElement}return n.join(" > ")}resolveElementByPath(e){if(!v()||!e)return null;try{return e.startsWith("#"),document.querySelector(e)}catch{return null}}attachKeyHandler(){this.keyHandler||!v()||(this.keyHandler=e=>{const n=e.key?.toLowerCase?.(),s=e.code;if(!n&&!s||(y=>{const c=y,r=c&&c.nodeType===3?c.parentElement:c;if(!r)return!1;if(r.tagName==="INPUT"||r.tagName==="TEXTAREA")return!0;let a=r;for(;a;){if(a.isContentEditable)return!0;a=a.parentElement}return!1})(e.target))return;(e.shiftKey&&(n==="c"||s==="KeyC"))===!0&&this.toggleVisibility()},window.addEventListener("keydown",this.keyHandler),document.addEventListener("keydown",this.keyHandler))}detachKeyHandler(){this.keyHandler&&(window.removeEventListener("keydown",this.keyHandler),document.removeEventListener("keydown",this.keyHandler),this.keyHandler=null)}isVisible(){return this.visible}show(){this.visible=!0,this.overlayElement&&(this.overlayElement.style.display="");try{window.dispatchEvent(new CustomEvent("prototype-comments:visibility",{detail:{visible:!0}}))}catch{}}hide(){this.visible=!1,this.overlayElement&&(this.overlayElement.style.display="none");try{window.dispatchEvent(new CustomEvent("prototype-comments:visibility",{detail:{visible:!1}}))}catch{}}toggleVisibility(){this.visible?this.hide():this.show()}}const H=new U;function W(h){H.enable(h)}function j(h){H.setDebug(h)}function q(){return H.isEnabled===!0}function J(){if(!v())return()=>{};const h=document.querySelector("[data-prototype-comments-controls]");if(h)return()=>{const d=h.parentElement;d&&d.removeChild(h)};const e=document.createElement("div");e.setAttribute("data-prototype-comments-controls",""),e.style.position="fixed",e.style.left="50%",e.style.bottom="20px",e.style.transform="translateX(-50%)",e.style.zIndex="2147483647",e.style.display="flex",e.style.gap="8px",e.style.alignItems="center",e.style.background="rgba(255,255,255,0.1)",e.style.backdropFilter="saturate(180%) blur(8px)",e.style.border="1px solid rgba(0,0,0,0.25)",e.style.borderRadius="16px",e.style.padding="8px 8px",e.style.boxShadow="0 4px 16px rgba(0,0,0,0.12)";const n=d=>{const i=document.createElement("button");return i.textContent=d,i.style.cursor="pointer",i.style.border="1px solid rgba(0,0,0,0.25)",i.style.borderRadius="8px",i.style.padding="8px 12px",i.style.background="rgba(255,255,255,0.6)",i.style.color="#111827",i.style.font="14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",i.style.boxShadow="0 1px 2px rgba(0,0,0,0.06)",i.style.transition="background-color 150ms ease, box-shadow 150ms ease, transform 120ms ease, border-color 150ms ease, color 150ms ease",i.addEventListener("mouseenter",()=>{i.style.background="#f9fafb",i.style.boxShadow="0 2px 6px rgba(0,0,0,0.08)"}),i.addEventListener("mouseleave",()=>{i.style.background="rgba(255,255,255,0.6)",i.style.boxShadow="0 1px 2px rgba(0,0,0,0.06)"}),i.addEventListener("mousedown",()=>{i.style.transform="scale(0.98)"}),i.addEventListener("mouseup",()=>{i.style.transform="translateZ(0)"}),i},s=n("Add comment (C)");s.title="Shortcut: C";let o=!1;const t=()=>{s.textContent=o?"Click to place… (C)":"Add comment (C)";const d=o?"crosshair":"";document.body.style.cursor=d,document.documentElement.style.cursor=d;const i=document.querySelector("[data-prototype-comments-overlay]");i&&(i.style.cursor=d)},y=()=>{o&&(o=!1,t(),document.removeEventListener("click",c,!0))},c=d=>{if(!o)return;const i=d.target;if(i&&(i.closest("[data-prototype-comments-controls]")||i.closest("[data-prototype-comment-editor]")))return;const S=d.clientX,R=d.clientY;H.beginCommentAt(S,R),y()};s.addEventListener("click",d=>{d.stopPropagation(),o=!o,t(),o?document.addEventListener("click",c,!0):document.removeEventListener("click",c,!0)}),t();const r=n("Hide comments (Shift+C)");r.title="Shortcut: Shift+C";const a=()=>{r.textContent=H.isVisible()?"Hide comments (Shift+C)":"Show comments (Shift+C)"};a(),r.addEventListener("click",d=>{d.stopPropagation(),H.toggleVisibility(),a(),O()});const l=n("Clear"),m=n("Confirm");m.style.background="#111827",m.style.color="white",m.style.display="none",m.addEventListener("mouseenter",()=>{m.style.background="#111827",m.style.color="white"}),m.addEventListener("mouseleave",()=>{m.style.background="#111827",m.style.color="white"}),m.addEventListener("mousedown",()=>{m.style.transform="scale(0.98)"}),m.addEventListener("mouseup",()=>{m.style.transform="translateZ(0)"});const b=n("Cancel");b.style.display="none";let g=!1;const C=d=>{g=d,O(),a()};l.addEventListener("click",d=>{d.stopPropagation(),C(!0)}),b.addEventListener("click",d=>{d.stopPropagation(),C(!1)}),m.addEventListener("click",d=>{d.stopPropagation(),H.clear(),C(!1)});const L=document.createElement("div");L.style.position="relative";const f=n("Export Comments"),p=document.createElement("div");p.style.position="absolute",p.style.right="0",p.style.bottom="42px",p.style.display="none",p.style.background="rgba(255,255,255,0.98)",p.style.border="1px solid rgba(0,0,0,0.12)",p.style.borderRadius="12px",p.style.padding="8px",p.style.minWidth="200px",p.style.boxShadow="0 8px 24px rgba(0,0,0,0.12)";const E=d=>{const i=document.createElement("button");return i.textContent=d,i.style.width="100%",i.style.textAlign="left",i.style.cursor="pointer",i.style.border="none",i.style.borderRadius="8px",i.style.padding="8px 10px",i.style.background="transparent",i.style.color="#111827",i.style.font="14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif",i.addEventListener("mouseenter",()=>{i.style.background="#f3f4f6"}),i.addEventListener("mouseleave",()=>{i.style.background="transparent"}),i},u=E("Export JSON"),x=E("Export Markdown"),w=E("Cancel");w.style.background="white",w.style.color="#111827",w.addEventListener("mouseenter",()=>{w.style.background="white",w.style.color="#111827"}),w.addEventListener("mouseleave",()=>{w.style.background="white",w.style.color="#111827"}),w.addEventListener("mousedown",()=>{w.style.transform="scale(0.98)"}),w.addEventListener("mouseup",()=>{w.style.transform="translateZ(0)"});const Y=()=>{p.style.display=p.style.display==="none"?"block":"none"};f.addEventListener("click",d=>{d.stopPropagation(),Y()}),u.addEventListener("click",()=>{const d=H.export(),i=(Array.isArray(d),d);V(i),p.style.display="none"}),x.addEventListener("click",()=>{const d=H.export();if(typeof d=="string")V(d);else{const i=[],S=d;if(S.length){i.push("# Comments","");for(const R of S){const M=new Date(R.timestamp).toISOString();i.push(`- (${R.x}, ${R.y}) ${String(R.text).replace(/[\\`*_{}\[\]()#+\-.!|]/g,I=>`\\${I}`)} — ${M}`)}}V(i.join(`
`))}p.style.display="none"}),w.addEventListener("click",()=>{p.style.display="none"}),p.appendChild(u),p.appendChild(x);const A=document.createElement("div");A.style.height="8px",p.appendChild(A),p.appendChild(w),L.appendChild(f),L.appendChild(p);function V(d){const i=new Date,S=$=>String($).padStart(2,"0"),R=`${i.getFullYear()}${S(i.getMonth()+1)}${S(i.getDate())}-${S(i.getHours())}${S(i.getMinutes())}${S(i.getSeconds())}`;let M,I;if(typeof d=="string")M=new Blob([d],{type:"text/markdown;charset=utf-8"}),I=`comments-${R}.md`;else{const $=JSON.stringify(d,null,2);M=new Blob([$],{type:"application/json;charset=utf-8"}),I=`comments-${R}.json`}const B=URL.createObjectURL(M),P=document.createElement("a");P.href=B,P.download=I,P.style.display="none",P.addEventListener("click",$=>$.stopPropagation(),{once:!0}),e.appendChild(P),P.click(),e.removeChild(P),URL.revokeObjectURL(B)}const O=()=>{const d=H.isVisible()&&q();if(r.style.display=g?"none":"",!d){L.style.display="none",l.style.display="none",b.style.display="none",m.style.display="none",s.style.display="none",y();return}L.style.display=g?"none":"",s.style.display=g?"none":"",g?(l.style.display="none",m.style.display="",b.style.display=""):(l.style.display="",m.style.display="none",b.style.display="none")};O();const k=()=>{a(),O(),H.isVisible()||y()};window.addEventListener("prototype-comments:visibility",k),window.addEventListener("keydown",d=>{const i=d.key.toLowerCase();(R=>{const M=R,I=M&&M.nodeType===3?M.parentElement:M;if(!I)return!1;if(I.tagName==="INPUT"||I.tagName==="TEXTAREA")return!0;let B=I;for(;B;){if(B.isContentEditable)return!0;B=B.parentElement}return!1})(d.target)||i==="c"&&!d.shiftKey&&(o=!o,t(),o?document.addEventListener("click",c,!0):document.removeEventListener("click",c,!0))}),e.appendChild(s),e.appendChild(L),e.appendChild(l),e.appendChild(m),e.appendChild(b),e.appendChild(r),document.body.appendChild(e);const T=d=>{p.style.display==="block"&&(p.style.display="none")};return window.addEventListener("click",T,!0),()=>{const d=e.parentElement;d&&d.removeChild(e),window.removeEventListener("click",T,!0),window.removeEventListener("prototype-comments:visibility",k)}}const K=H;j(!0);W({storage:"localStorage",exportFormat:"markdown",debug:!0});let X=!1;function _(){const h=X?"crosshair":"";document.body.style.cursor=h,document.documentElement.style.cursor=h;const e=document.querySelector("[data-prototype-comments-overlay]");e&&(e.style.cursor=h)}J();window.addEventListener("keydown",h=>{if((s=>{if(!s)return!1;const o=s.nodeType===3?s.parentElement:s;if(!o)return!1;if(o.tagName==="INPUT"||o.tagName==="TEXTAREA")return!0;let t=o;for(;t;){if(t.isContentEditable)return!0;t=t.parentElement}return!1})(h.target))return;const n=h.key.toLowerCase();if(n==="c"&&!h.shiftKey)X=!X,_();else if(n==="c"&&h.shiftKey){const s=K;s&&typeof s.toggleVisibility=="function"&&s.toggleVisibility()}});document.addEventListener("click",h=>{if(!X)return;const e=h.target;if(e&&e.closest&&(e.closest("header")||e.closest("[data-prototype-comment-editor]")))return;const n=h.clientX,s=h.clientY;K.beginCommentAt(n,s)});
